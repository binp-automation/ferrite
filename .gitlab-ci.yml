# This file is generated by script 'ferrite/ci/gitlab/generate.py'
# Please, do not edit it manually

image: agerasev/debian-psc:0.3

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

cache: &global_cache
  - key: "global"
    paths:
      - poetry.lock
      - .venv
      - .cargo

stages:
  - "self_check"
  - "host_test"
  - "cross_build"

pytest:
  stage: "self_check"
  script:
    - poetry install
    - poetry run bash scripts/pytest.sh
  cache:
    - *global_cache

mypy:
  stage: "self_check"
  script:
    - poetry install
    - poetry run bash scripts/mypy.sh
  cache:
    - *global_cache
  allow_failure: true

ferrite.all.test:
  stage: "host_test"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-capture --hide-artifacts -j4 all.test
  artifacts:
    paths:
      - target/ferrite/app
      - target/ferrite/protogen/rust/target
  cache:
    - *global_cache
    - key: "$CI_JOB_NAME"
      paths:
        - target/rustup

example.host.all.test:
  stage: "host_test"
  script:
    - poetry install
    - poetry run python -u -m example.manage --no-capture --hide-artifacts -j4 host.all.test
  artifacts:
    paths:
      - target/example/app
      - target/example/protocol/rust/target
  cache:
    - *global_cache
    - key: "$CI_JOB_NAME"
      paths:
        - target/epics_base_7.0.6.1/host/build
        - target/epics_base_7.0.6.1/src
        - target/rustup

example.arm.all.build:
  stage: "cross_build"
  script:
    - poetry install
    - poetry run python -u -m example.manage --no-capture --hide-artifacts -j4 arm.all.build
  artifacts:
    paths:
      - target/epics_base_7.0.6.1/arm/install
      - target/example/ioc/arm/install
  cache:
    - *global_cache
    - key: "$CI_JOB_NAME"
      paths:
        - target/epics_base_7.0.6.1/arm/build
        - target/epics_base_7.0.6.1/host/build
        - target/epics_base_7.0.6.1/src
        - target/rustup
        - target/toolchain_gcc-arm-10.2-2020.11-x86_64-arm-none-linux-gnueabihf

example.aarch64.all.build:
  stage: "cross_build"
  script:
    - poetry install
    - poetry run python -u -m example.manage --no-capture --hide-artifacts -j4 aarch64.all.build
  artifacts:
    paths:
      - target/epics_base_7.0.6.1/aarch64/install
      - target/example/ioc/aarch64/install
  cache:
    - *global_cache
    - key: "$CI_JOB_NAME"
      paths:
        - target/epics_base_7.0.6.1/aarch64/build
        - target/epics_base_7.0.6.1/host/build
        - target/epics_base_7.0.6.1/src
        - target/rustup
        - target/toolchain_gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu
