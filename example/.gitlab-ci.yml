# This file is generated by script 'example/ci/gitlab/generate.py'
include:

cache: &example_cache
  - paths:
      - example/.venv
      - example/.cargo

example.mypy:
  stage: "self_check"
  script:
    - cd example
    - poetry install
    - poetry run mypy -p example
  cache:
    - *example_cache
  allow_failure: true

example.host.all.test:
  stage: "host_test"
  script:
    - cd example
    - poetry install
    - poetry run python -u -m example.manage --no-capture --hide-artifacts -j4 host.all.test
  artifacts:
    paths:
      - example/target/app
      - example/target/protocol/rust/target
  cache:
    - *example_cache
    - paths:
        - example/target/epics_base_7.0.6.1/host/build
        - example/target/epics_base_7.0.6.1/host/install
        - example/target/epics_base_7.0.6.1/src
        - example/target/rustup

example.arm.all.build:
  stage: "cross_build"
  script:
    - cd example
    - poetry install
    - poetry run python -u -m example.manage --no-capture --hide-artifacts -j4 arm.all.build
  needs:
    - example.host.all.test
  artifacts:
    paths:
      - example/target/epics_base_7.0.6.1/arm/build
      - example/target/epics_base_7.0.6.1/arm/install
      - example/target/ioc/arm/build
      - example/target/ioc/arm/install
      - example/target/ioc/src
  cache:
    - *example_cache
    - paths:
        - example/target/epics_base_7.0.6.1/arm/build
        - example/target/epics_base_7.0.6.1/arm/install
        - example/target/epics_base_7.0.6.1/host/build
        - example/target/epics_base_7.0.6.1/host/install
        - example/target/epics_base_7.0.6.1/src
        - example/target/rustup
        - example/target/toolchain_gcc-arm-10.2-2020.11-x86_64-arm-none-linux-gnueabihf

example.aarch64.all.build:
  stage: "cross_build"
  script:
    - cd example
    - poetry install
    - poetry run python -u -m example.manage --no-capture --hide-artifacts -j4 aarch64.all.build
  needs:
    - example.host.all.test
  artifacts:
    paths:
      - example/target/epics_base_7.0.6.1/aarch64/build
      - example/target/epics_base_7.0.6.1/aarch64/install
      - example/target/ioc/aarch64/build
      - example/target/ioc/aarch64/install
      - example/target/ioc/src
  cache:
    - *example_cache
    - paths:
        - example/target/epics_base_7.0.6.1/aarch64/build
        - example/target/epics_base_7.0.6.1/aarch64/install
        - example/target/epics_base_7.0.6.1/host/build
        - example/target/epics_base_7.0.6.1/host/install
        - example/target/epics_base_7.0.6.1/src
        - example/target/rustup
        - example/target/toolchain_gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu
