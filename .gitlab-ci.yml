# This file is generated by script 'ferrite/ci/gitlab/script.py'

image: agerasev/debian-psc

stages:
  - "-1"
  - "0"
  - "1"
  - "2"
  - "3"
  - "4"

yapf:
  stage: "-1"
  script:
    - poetry install
    - poetry run yapf --diff --recursive ferrite
  allow_failure: true

mypy:
  stage: "-1"
  script:
    - poetry install
    - poetry run mypy -p ferrite
  allow_failure: true

host_codegen.generate:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_codegen.generate
  artifacts:
    paths:
      - target/codegen_test_src

host_ipp.generate:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_ipp.generate
  artifacts:
    paths:
      - target/ipp_generated

host_epics_base.clone:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_src

imx8mn_mcu_toolchain.download:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_mcu_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-arm-none-eabi-9-2020-q2-update

imx8mn_freertos.clone:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_freertos.clone
  artifacts:
    paths:
      - target/mcuxpresso_sdk_2.9.x-var01

imx8mn_app_toolchain.download:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_app_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu

host_codegen.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_codegen.build
  needs:
    - host_codegen.generate
  artifacts:
    paths:
      - target/codegen_host

host_ipp.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_ipp.build
  needs:
    - host_ipp.generate
  artifacts:
    paths:
      - target/ipp_host

host_app.build_unittest:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_app.build_unittest
  needs:
    - host_ipp.generate
  artifacts:
    paths:
      - target/app_host

host_epics_base.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_epics_base.build
  needs:
    - host_epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_build_host
      - target/epics_base_7.0.4.1_install_host

host_app.build_fakedev:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_app.build_fakedev
  needs:
    - host_ipp.generate
  artifacts:
    paths:
      - target/app_host

imx8mn_mcu.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_mcu.build
  needs:
    - imx8mn_mcu_toolchain.download
    - imx8mn_freertos.clone
    - host_ipp.generate
  artifacts:
    paths:
      - target/mcu_imx8mn

imx8mn_app.build_main:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_app.build_main
  needs:
    - imx8mn_app_toolchain.download
    - host_ipp.generate
  artifacts:
    paths:
      - target/app_imx8mn

host_codegen.test:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_codegen.test
  needs:
    - host_codegen.build

host_ipp.test:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_ipp.test
  needs:
    - host_ipp.build

host_app.run_unittest:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_app.run_unittest
  needs:
    - host_app.build_unittest

host_ioc.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_ioc.build
  needs:
    - host_epics_base.build
    - host_app.build_fakedev
  artifacts:
    paths:
      - target/ioc_build_host
      - target/ioc_install_host

imx8mn_epics_base.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_epics_base.build
  needs:
    - imx8mn_app_toolchain.download
    - host_epics_base.build
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_build_imx8mn
      - target/epics_base_7.0.4.1_install_imx8mn

host_ioc.test_fakedev:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_ioc.test_fakedev
  needs:
    - host_epics_base.build
    - host_ioc.build

imx8mn_ioc.build:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_ioc.build
  needs:
    - imx8mn_app_toolchain.download
    - imx8mn_epics_base.build
    - imx8mn_app.build_main
  artifacts:
    paths:
      - target/ioc_build_imx8mn
      - target/ioc_install_imx8mn

host_all.test:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host_all.test
  needs:
    - host_codegen.test
    - host_ipp.test
    - host_app.run_unittest
    - host_ioc.test_fakedev

imx8mn_all.build:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture imx8mn_all.build
  needs:
    - imx8mn_mcu.build
    - imx8mn_epics_base.build
    - imx8mn_ioc.build
