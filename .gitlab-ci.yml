# This file is generated by script 'ferrite/ci/gitlab/generate.py'

image: agerasev/debian-psc

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

cache: &global_cache
  - key:
      files:
        - pyproject.toml
    paths:
      - poetry.lock
      - .venv/

stages:
  - "-1"
  - "0"
  - "1"
  - "2"
  - "3"

yapf:
  stage: "-1"
  script:
    - poetry install
    - poetry run yapf --diff --recursive ferrite
  allow_failure: true

mypy:
  stage: "-1"
  script:
    - poetry install
    - poetry run mypy -p ferrite
  allow_failure: true

codegen.generate:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture codegen.generate
  artifacts:
    paths:
      - target/codegen_generated

app_test.build:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture app_test.build
  artifacts:
    paths:
      - target/app_test

codegen.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture codegen.build
  needs:
    - codegen.generate
  artifacts:
    paths:
      - target/codegen_host

app_test.test:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture app_test.test
  needs:
    - app_test.build

codegen.test:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture codegen.test
  needs:
    - codegen.build

all.test:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture all.test
  needs:
    - app_test.test
    - codegen.test
