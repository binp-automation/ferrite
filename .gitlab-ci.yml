# This file is generated by script 'ferrite/ci/gitlab/generate.py'

image: agerasev/debian-psc:0.3

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

cache: &global_cache
  - key:
      files:
        - pyproject.toml
    paths:
      - poetry.lock
      - .venv/

stages:
  - "main"

all.test:
  stage: "main"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-capture --hide-artifacts all.test
  artifacts:
    paths:
      - target/app
      - target/cargo
      - target/codegen/rust/target
  cache:
    - *global_cache
    - paths:
        - target/cargo
        - target/rustup
mypy:
  stage: "main"
  script:
    - poetry install
    - poetry run mypy -p ferrite
  cache:
    - *global_cache
  allow_failure: true
