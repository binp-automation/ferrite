# This file is generated by script 'ferrite/ci/gitlab/generate.py'
image: agerasev/debian-psc:0.3

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

stages:
  - "self_check"
  - "host_test"
  - "cross_build"

include:
  - /example/.gitlab-ci.yml

cache: &global_cache
  - paths:
      - poetry.lock
      - .venv
      - .cargo

ferrite.pytest:
  stage: "self_check"
  script:
    - poetry install
    - poetry run python -m pytest
  cache:
    - *global_cache

ferrite.mypy:
  stage: "self_check"
  script:
    - poetry install
    - poetry run mypy -p ferrite
  cache:
    - *global_cache
  allow_failure: true

ferrite.all.test:
  stage: "host_test"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-capture --hide-artifacts -j4 all.test
  artifacts:
    paths:
      - target/app
      - target/protogen/rust/target
  cache:
    - *global_cache
    - paths:
        - target/rustup
