# This file is generated by script 'ferrite/ci/gitlab/generate.py'

image: agerasev/debian-psc:0.3

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

cache: &global_cache
  - key:
      files:
        - pyproject.toml
    paths:
      - poetry.lock
      - .venv/
  - key: cargo
    paths:
      - target/cargo

stages:
  - "-1"
  - "0"
  - "1"
  - "2"
  - "3"
  - "4"

yapf:
  stage: "-1"
  script:
    - poetry install
    - poetry run yapf --diff --recursive ferrite
  allow_failure: true

mypy:
  stage: "-1"
  script:
    - poetry install
    - poetry run mypy -p ferrite
  allow_failure: true

host.codegen.generate:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.codegen.generate
  artifacts:
    paths:
      - target/codegen

host.toolchain.install:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.toolchain.install

host.rustup.install:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.rustup.install
  artifacts:
    paths:
      - target/rustup
  cache:
    - *global_cache
    - key: "host.rustup.install:2556056a"
      paths:
        - target/rustup

host.epics_base.clone:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.6.1_src
  cache:
    - *global_cache
    - key: "host.epics_base.clone:a1b50a23"
      paths:
        - target/epics_base_7.0.6.1_src

arm.gcc.install:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture arm.gcc.install
  artifacts:
    paths:
      - target/toolchain_gcc-arm-10.2-2020.11-x86_64-arm-none-linux-gnueabihf
  cache:
    - *global_cache
    - key: "arm.gcc.install:2d7f1739"
      paths:
        - target/toolchain_gcc-arm-10.2-2020.11-x86_64-arm-none-linux-gnueabihf

arm.rustup.install:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture arm.rustup.install
  artifacts:
    paths:
      - target/rustup
  cache:
    - *global_cache
    - key: "arm.rustup.install:2556056a"
      paths:
        - target/rustup

aarch64.gcc.install:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture aarch64.gcc.install
  artifacts:
    paths:
      - target/toolchain_gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu
  cache:
    - *global_cache
    - key: "aarch64.gcc.install:f93a1603"
      paths:
        - target/toolchain_gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu

aarch64.rustup.install:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture aarch64.rustup.install
  artifacts:
    paths:
      - target/rustup
  cache:
    - *global_cache
    - key: "aarch64.rustup.install:2556056a"
      paths:
        - target/rustup

host.codegen.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.codegen.build
  needs:
    - host.codegen.generate
    - host.toolchain.install
  artifacts:
    paths:
      - target/codegen_test

host.app.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.app.build
  needs:
    - host.rustup.install
    - host.toolchain.install
  artifacts:
    paths:
      - target/app

host.epics_base.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.epics_base.build
  needs:
    - host.epics_base.clone
    - host.toolchain.install
  artifacts:
    paths:
      - target/epics_base_7.0.6.1_build_host
      - target/epics_base_7.0.6.1_install_host
  cache:
    - *global_cache
    - key: "host.epics_base.build:1331b00"
      paths:
        - target/epics_base_7.0.6.1_build_host
        - target/epics_base_7.0.6.1_install_host

arm.app.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture arm.app.build
  needs:
    - arm.gcc.install
    - arm.rustup.install
  artifacts:
    paths:
      - target/app

aarch64.app.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture aarch64.app.build
  needs:
    - aarch64.gcc.install
    - aarch64.rustup.install
  artifacts:
    paths:
      - target/app

host.codegen.test:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.codegen.test
  needs:
    - host.codegen.build

host.app.test:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.app.test
  needs:
    - host.app.build
    - host.rustup.install

host.ioc_example.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.ioc_example.build
  needs:
    - host.app.build
    - host.epics_base.build
    - host.toolchain.install
  artifacts:
    paths:
      - target/ioc_host/ioc_build_host
      - target/ioc_host/ioc_install_host

arm.epics_base.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture arm.epics_base.build
  needs:
    - arm.gcc.install
    - host.epics_base.build
  artifacts:
    paths:
      - target/epics_base_7.0.6.1_build_arm
      - target/epics_base_7.0.6.1_install_arm
  cache:
    - *global_cache
    - key: "arm.epics_base.build:c63e1a04"
      paths:
        - target/epics_base_7.0.6.1_build_arm
        - target/epics_base_7.0.6.1_install_arm

aarch64.epics_base.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture aarch64.epics_base.build
  needs:
    - aarch64.gcc.install
    - host.epics_base.build
  artifacts:
    paths:
      - target/epics_base_7.0.6.1_build_aarch64
      - target/epics_base_7.0.6.1_install_aarch64
  cache:
    - *global_cache
    - key: "aarch64.epics_base.build:976d1c56"
      paths:
        - target/epics_base_7.0.6.1_build_aarch64
        - target/epics_base_7.0.6.1_install_aarch64

host.fakedev.test:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.fakedev.test
  needs:
    - host.ioc_example.build

arm.ioc_example.build:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture arm.ioc_example.build
  needs:
    - arm.app.build
    - arm.epics_base.build
    - arm.gcc.install
  artifacts:
    paths:
      - target/ioc_arm/ioc_build_arm
      - target/ioc_arm/ioc_install_arm

aarch64.ioc_example.build:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture aarch64.ioc_example.build
  needs:
    - aarch64.app.build
    - aarch64.epics_base.build
    - aarch64.gcc.install
  artifacts:
    paths:
      - target/ioc_aarch64/ioc_build_aarch64
      - target/ioc_aarch64/ioc_install_aarch64

host.all.test:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture host.all.test
  needs:
    - host.app.test
    - host.codegen.test
    - host.fakedev.test

arm.all.build:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture arm.all.build
  needs:
    - arm.epics_base.build
    - arm.ioc_example.build

aarch64.all.build:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m ferrite.manage --no-deps --no-capture aarch64.all.build
  needs:
    - aarch64.epics_base.build
    - aarch64.ioc_example.build
